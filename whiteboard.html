<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MathBoard Pro - Interactive Math Whiteboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js" async></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          animation: {
            'slide-in-right': 'slideInRight 0.3s ease-out',
            'slide-out-right': 'slideOutRight 0.3s ease-in',
            'fade-in': 'fadeIn 0.2s ease-out',
            'bounce-in': 'bounceIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
            'tooltip': 'tooltip 0.2s ease-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'slide-down': 'slideDown 0.3s ease-in',
            'scale-in': 'scaleIn 0.3s ease-out',
          },
          keyframes: {
            slideInRight: {
              '0%': { transform: 'translateX(100%)', opacity: '0' },
              '100%': { transform: 'translateX(0)', opacity: '1' }
            },
            slideOutRight: {
              '0%': { transform: 'translateX(0)', opacity: '1' },
              '100%': { transform: 'translateX(100%)', opacity: '0' }
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            bounceIn: {
              '0%': { transform: 'scale(0.3)', opacity: '0' },
              '50%': { transform: 'scale(1.05)' },
              '70%': { transform: 'scale(0.9)' },
              '100%': { transform: 'scale(1)', opacity: '1' }
            },
            tooltip: {
              '0%': { opacity: '0', transform: 'translateY(5px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            slideUp: {
              '0%': { transform: 'translateY(100%)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            },
            slideDown: {
              '0%': { transform: 'translateY(0)', opacity: '1' },
              '100%': { transform: 'translateY(100%)', opacity: '0' }
            },
            scaleIn: {
              '0%': { transform: 'scale(0)', opacity: '0' },
              '100%': { transform: 'scale(1)', opacity: '1' }
            }
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8'
            }
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    .glass {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .glass-strong {
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(156, 163, 175, 0.5);
      border-radius: 3px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(156, 163, 175, 0.8);
    }
    
    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(75, 85, 99, 0.5);
    }
    
    .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(75, 85, 99, 0.8);
    }
    
    /* Tool button active state */
    .tool-active {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    /* Canvas backgrounds */
    .canvas-light {
      background: #ffffff;
    }
    
    .canvas-dark {
      background: #1f2937;
    }
    
    /* LaTeX overlay styling */
    .latex-overlay {
      transition: all 0.2s ease;
      border-radius: 8px;
      padding: 6px 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .latex-overlay-light {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(0, 0, 0, 0.1);
      color: #1f2937;
    }
    
    .latex-overlay-dark {
      background: rgba(31, 41, 59, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #f8fafc;
    }
    
    .latex-overlay:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Notification styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      min-width: 300px;
      animation: slideInRight 0.3s ease-out;
    }
    
    .notification.removing {
      animation: slideOutRight 0.3s ease-in forwards;
    }
    
    /* Canvas cursor styles */
    .canvas-crosshair { cursor: crosshair; }
    .canvas-pointer { cursor: pointer; }
    .canvas-grab { cursor: grab; }
    .canvas-grabbing { cursor: grabbing; }
    
    /* Toggle switch */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: #d1d5db;
      border-radius: 12px;
      transition: background 0.3s ease;
      cursor: pointer;
    }
    
    .toggle-switch.active {
      background: #3b82f6;
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .toggle-switch.active::after {
      transform: translateX(20px);
    }
    
    /* Tooltip styles */
    .tooltip {
      position: relative;
    }
    
    .tooltip::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-5px);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease;
      z-index: 1000;
    }
    
    .tooltip::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(1px);
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 4px solid rgba(0, 0, 0, 0.9);
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease;
    }
    
    .tooltip:hover::before,
    .tooltip:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    /* Sample buttons */
    .sample-btn {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .sample-btn:hover {
      background: #f3f4f6;
      transform: translateY(-1px);
    }
    
    .dark .sample-btn:hover {
      background: #374151;
    }
    
    /* Chat panel animations */
    .chat-panel-enter {
      animation: slideInRight 0.3s ease-out;
    }
    
    .chat-panel-exit {
      animation: slideOutRight 0.3s ease-in forwards;
    }
    
    /* Notes panel animations */
    .notes-panel-show {
      animation: slideUp 0.3s ease-out;
    }
    
    .notes-panel-hide {
      animation: slideDown 0.3s ease-in forwards;
    }
    
    .notes-panel-hidden {
      transform: translateY(100%);
      opacity: 0;
      pointer-events: none;
    }
    
    .floating-btn-show {
      animation: scaleIn 0.3s ease-out;
    }
    
    /* Responsive breakpoints */
    @media (max-width: 768px) {
      .mobile-hide { display: none !important; }
      .mobile-show { display: block !important; }
    }
    
    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .tooltip::before {
        background: #000;
        border: 1px solid #fff;
      }
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
  <div id="container" class="flex h-screen w-screen overflow-hidden">
    <!-- Main Panel -->
    <div id="main-panel" class="flex-1 flex flex-col min-w-0">
      <!-- Enhanced Toolbar -->
      <div id="toolbar" class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3 shadow-sm">
        <div class="flex items-center justify-between gap-4 min-w-0">
          <!-- Left Side - Tools -->
          <div class="flex items-center gap-4 min-w-0 flex-shrink">
            <!-- Drawing Tools -->
            <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg p-1 gap-1 flex-shrink-0">
              <button id="tool-pen" class="tool-btn tooltip px-3 py-2 rounded-md transition-all duration-200 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-600" data-tooltip="Freehand Drawing (1)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                </svg>
              </button>
              <button id="tool-line" class="tool-btn tooltip px-3 py-2 rounded-md transition-all duration-200 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-600" data-tooltip="Line Tool (2)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
              </button>
              <button id="tool-rect" class="tool-btn tooltip px-3 py-2 rounded-md transition-all duration-200 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-600" data-tooltip="Rectangle (3)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
              </button>
              <button id="tool-circle" class="tool-btn tooltip px-3 py-2 rounded-md transition-all duration-200 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-600" data-tooltip="Circle (4)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10"></circle>
                </svg>
              </button>
              <button id="tool-eraser" class="tool-btn tooltip px-3 py-2 rounded-md transition-all duration-200 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-600" data-tooltip="Eraser (5)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
            
            <!-- LaTeX Tool (Separated) -->
            <div class="flex items-center bg-purple-100 dark:bg-purple-900/30 rounded-lg p-1 flex-shrink-0">
              <button id="tool-latex" class="tool-btn tooltip px-3 py-2 rounded-md transition-all duration-200 text-sm font-medium text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800/50 flex items-center gap-2" data-tooltip="LaTeX Math Equations (6)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                <span>LaTeX</span>
              </button>
            </div>
            
            <!-- Color & Size -->
            <div class="flex items-center gap-3 bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2 flex-shrink-0">
              <label class="text-xs font-medium text-gray-600 dark:text-gray-400 whitespace-nowrap">Color:</label>
              <input type="color" id="colorPicker" value="#3b82f6" class="w-8 h-8 rounded border-0 cursor-pointer tooltip" data-tooltip="Choose drawing color">
              <label class="text-xs font-medium text-gray-600 dark:text-gray-400 whitespace-nowrap">Size:</label>
              <input type="number" id="sizePicker" min="1" max="12" value="3" class="w-12 text-center bg-transparent text-gray-700 dark:text-gray-300 text-sm tooltip" data-tooltip="Brush size (1-12)">
            </div>
            
            <!-- Actions -->
            <div class="flex items-center gap-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-1 flex-shrink-0">
              <button id="undo-btn" class="tooltip px-3 py-2 text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-600 rounded-md transition-all duration-200 text-sm font-medium" data-tooltip="Undo (Ctrl+Z)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                </svg>
              </button>
              <button id="redo-btn" class="tooltip px-3 py-2 text-gray-700 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-600 rounded-md transition-all duration-200 text-sm font-medium" data-tooltip="Redo (Ctrl+Y)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"></path>
                </svg>
              </button>
              <button id="clear-btn" class="tooltip px-3 py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-all duration-200 text-sm font-medium" data-tooltip="Clear All">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
              <button id="snapshot-btn" class="tooltip px-3 py-2 text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-md transition-all duration-200 text-sm font-medium" data-tooltip="Save Image (Ctrl+S)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
              </button>
            </div>
          </div>
          
          <!-- Right Side - Controls -->
          <div class="flex items-center gap-4 flex-shrink-0">
            <!-- Theme Toggle -->
            <button id="theme-toggle" class="tooltip p-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-200" data-tooltip="Toggle Theme">
              <svg class="w-5 h-5 dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
              </svg>
              <svg class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
              </svg>
            </button>
            
            <!-- Teacher Controls -->
            <div class="flex items-center gap-3 bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2">
              <label class="text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2 whitespace-nowrap">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 01-3 0m3 0H9m1.5-2.25L9 15l-2.25-2.25M15 10.5l4.5-4.5M21 10.5l-4.5-4.5"></path>
                </svg>
                Teacher Mode
              </label>
              <div id="teacher-toggle" class="toggle-switch active tooltip" data-tooltip="Enable/disable student controls"></div>
            </div>
            
            <!-- User Selector -->
            <select id="user-menu" class="tooltip bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-tooltip="Switch user role">
              <option value="Teacher">👩‍🏫 Teacher</option>
              <option value="Student A">👦 Student A</option>
              <option value="Student B">👧 Student B</option>
              <option value="Student C">👧 Student C</option>
            </select>
            
            <!-- Chat Toggle (Mobile) -->
            <button id="chat-toggle-mobile" class="tooltip md:hidden p-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-200" data-tooltip="Toggle Chat">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Whiteboard -->
      <div id="whiteboard" class="flex-1 relative overflow-hidden">
        <canvas id="canvas" class="absolute inset-0 w-full h-full block canvas-crosshair touch-none canvas-light"></canvas>
        
        <!-- Cursor Position -->
        <div id="cursor-pos" class="absolute bottom-4 right-4 bg-black/80 text-white text-xs px-2 py-1 rounded opacity-0 transition-opacity duration-200 pointer-events-none z-10"></div>
        
        <!-- LaTeX Panel -->
        <div id="latex-panel" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 mx-4 w-full max-w-4xl animate-bounce-in max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                Insert LaTeX Equation
              </h3>
              <button id="latex-close" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <!-- LaTeX Input -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Enter LaTeX Expression:</label>
              <input id="latex-input" type="text" placeholder="e.g. \int_0^1 x^2 dx or \frac{a}{b}" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm">
            </div>
            
            <!-- LaTeX Preview -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Preview:</label>
              <div id="latex-preview" class="min-h-[80px] bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 dark:text-gray-300 rounded-lg p-4 flex items-center justify-center text-lg">
                <span class="text-gray-700 dark:text-gray-300">Enter LaTeX equation above...</span>
              </div>
            </div>
            
            <!-- Sample Equations -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Quick Samples - Click to Use:</label>
              <div class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                <button class="sample-btn flex-shrink-0 text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 min-w-[200px]" data-latex="\frac{a}{b}">
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-xs text-gray-600 dark:text-gray-400">\frac{a}{b}</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Fraction</span>
                  </div>
                </button>
                <button class="sample-btn flex-shrink-0 text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 min-w-[200px]" data-latex="x^2 + y^2 = r^2">
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-xs text-gray-600 dark:text-gray-400">x^2 + y^2 = r^2</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Pythagorean</span>
                  </div>
                </button>
                <button class="sample-btn flex-shrink-0 text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 min-w-[200px]" data-latex="\int_0^1 x^2 dx">
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-xs text-gray-600 dark:text-gray-400">\int_0^1 x^2 dx</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Integral</span>
                  </div>
                </button>
                <button class="sample-btn flex-shrink-0 text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 min-w-[200px]" data-latex="\sum_{n=1}^{\infty} \frac{1}{n^2}">
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-xs text-gray-600 dark:text-gray-400">\sum_{n=1}^{\infty} \frac{1}{n^2}</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Sum</span>
                  </div>
                </button>
                <button class="sample-btn flex-shrink-0 text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 min-w-[200px]" data-latex="\lim_{x \to 0} \frac{\sin x}{x} = 1">
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-xs text-gray-600 dark:text-gray-400">\lim_{x \to 0} \frac{\sin x}{x} = 1</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Limit</span>
                  </div>
                </button>
                <button class="sample-btn flex-shrink-0 text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 min-w-[200px]" data-latex="\sqrt{a^2 + b^2}">
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-xs text-gray-600 dark:text-gray-400">\sqrt{a^2 + b^2}</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Square Root</span>
                  </div>
                </button>
                <button class="sample-btn flex-shrink-0 text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 min-w-[200px]" data-latex="\alpha + \beta = \gamma">
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-xs text-gray-600 dark:text-gray-400">\alpha + \beta = \gamma</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Greek Letters</span>
                  </div>
                </button>
                <button class="sample-btn flex-shrink-0 text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 min-w-[200px]" data-latex="\begin{pmatrix} a & b \\ c & d \end{pmatrix}">
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-xs text-gray-600 dark:text-gray-400">\begin{pmatrix} a & b \\ c & d \end{pmatrix}</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Matrix</span>
                  </div>
                </button>
                <button class="sample-btn flex-shrink-0 text-left p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 min-w-[200px]" data-latex="E = mc^2">
                  <div class="flex items-center gap-2">
                    <span class="font-mono text-xs text-gray-600 dark:text-gray-400">E = mc^2</span>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Einstein</span>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-end gap-3">
              <button id="latex-cancel" class="px-6 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200 border border-gray-300 dark:border-gray-600">Cancel</button>
              <button id="latex-insert" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors duration-200 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Insert Equation
              </button>
            </div>
          </div>
        </div>
        
        <!-- Notes Panel -->
        <div id="notes-panel" class="absolute left-4 bottom-4 w-80 max-w-[calc(100vw-2rem)] z-20 transition-all duration-300 ease-in-out">
          <div class="bg-white/95 dark:bg-gray-800/95 glass rounded-lg border border-gray-200 dark:border-gray-700 shadow-lg mb-3">
            <!-- Notes Panel Header -->
            <div class="flex items-center justify-between p-3 border-b border-gray-200 dark:border-gray-600">
              <h3 class="text-sm font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Quick Notes
              </h3>
              <button id="notes-close" class="tooltip p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors duration-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-tooltip="Close Notes Panel">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <form id="note-form" class="p-4">
              <textarea id="note-input" placeholder="Add step-by-step notes, explanations, or observations..." class="w-full h-20 resize-none border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 custom-scrollbar"></textarea>
              <button type="submit" class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg transition-colors duration-200 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Add Note
              </button>
            </form>
          </div>
          
          <div id="note-list" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar"></div>
        </div>
        
        <!-- Floating Notes Button (visible when notes panel is closed) -->
        <button id="notes-float-btn" class="fixed left-4 bottom-4 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg z-20 transition-all duration-300 ease-in-out tooltip hidden animate-bounce-in" data-tooltip="Open Notes Panel">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Collapsible Chat Panel -->
    <div id="chat-panel" class="w-80 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex flex-col shadow-lg transition-transform duration-300 ease-in-out md:translate-x-0 fixed md:relative right-0 top-0 h-full z-30">
      <!-- Chat Header -->
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-gray-50 dark:bg-gray-900/50">
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <h3 class="font-semibold text-gray-900 dark:text-white">Collaboration Chat</h3>
          </div>
        </div>
        <button id="chat-toggle" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
      </div>
      
      <!-- Chat Messages -->
      <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50/50 dark:bg-gray-900/20 custom-scrollbar"></div>
      
      <!-- Chat Input -->
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
        <div class="flex gap-2">
          <input id="chat-input" type="text" placeholder="Type your message..." class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
          <button id="chat-send" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Chat Expand Button (when collapsed) -->
    <button id="chat-expand" class="fixed right-4 top-1/2 transform -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-l-lg shadow-lg z-20 transition-all duration-300 hidden">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
      </svg>
    </button>
  </div>

  <script>
    // Global Variables
    let currentUser = "Teacher";
    let isTeacher = true;
    let teacherControl = true;
    let tool = "pen";
    let color = "#3b82f6";
    let size = 3;
    let actionStack = [];
    let redoStack = [];
    let currentAction = null;
    let isDrawing = false;
    let notes = [];
    let chat = [];
    let latexList = [];
    let isDarkMode = false;
    let isChatOpen = true;
    let isNotesOpen = true;
    
    // Canvas setup
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let dpr = window.devicePixelRatio || 1;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });
    
    function initializeApp() {
      setupCanvas();
      setupEventListeners();
      setupTheme();
      updateToolUI();
      updateStudentAccess();
      renderAll();
      showNotification('MathBoard Pro loaded successfully! 🚀', 'success');
      
      // Add welcome message
      setTimeout(() => {
        addSystemMessage("Welcome to MathBoard Pro! Use keyboard shortcuts 1-6 for tools, Ctrl+Z/Y for undo/redo.");
      }, 1000);
    }
    
    // Canvas Setup
    function setupCanvas() {
      function resizeCanvas() {
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + "px";
        canvas.style.height = rect.height + "px";
        ctx.scale(dpr, dpr);
        renderAll();
      }
      
      resizeCanvas();
      window.addEventListener('resize', debounce(resizeCanvas, 150));
    }
    
    // Theme System
    function setupTheme() {
      const themeToggle = document.getElementById('theme-toggle');
      const savedTheme = localStorage.getItem('theme');
      
      if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        enableDarkMode();
      }
      
      themeToggle.addEventListener('click', toggleTheme);
    }
    
    function toggleTheme() {
      if (isDarkMode) {
        disableDarkMode();
      } else {
        enableDarkMode();
      }
    }
    
    function enableDarkMode() {
      document.documentElement.classList.add('dark');
      canvas.classList.remove('canvas-light');
      canvas.classList.add('canvas-dark');
      localStorage.setItem('theme', 'dark');
      isDarkMode = true;
      updateLatexOverlays();
    }
    
    function disableDarkMode() {
      document.documentElement.classList.remove('dark');
      canvas.classList.remove('canvas-dark');
      canvas.classList.add('canvas-light');
      localStorage.setItem('theme', 'light');
      isDarkMode = false;
      updateLatexOverlays();
    }
    
    function updateLatexOverlays() {
      document.querySelectorAll('.latex-overlay').forEach(overlay => {
        overlay.classList.remove('latex-overlay-light', 'latex-overlay-dark');
        overlay.classList.add(isDarkMode ? 'latex-overlay-dark' : 'latex-overlay-light');
      });
    }
    
    // Event Listeners
    function setupEventListeners() {
      // Tool buttons
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const toolName = e.currentTarget.id.replace('tool-', '');
          selectTool(toolName);
        });
      });
      
      // Canvas events
      canvas.addEventListener('pointerdown', handlePointerDown);
      canvas.addEventListener('pointermove', handlePointerMove);
      canvas.addEventListener('pointerup', handlePointerUp);
      canvas.addEventListener('pointerleave', handlePointerLeave);
      
      // Toolbar controls
      document.getElementById('colorPicker').addEventListener('input', (e) => {
        color = e.target.value;
        showNotification(`Color changed to ${color}`, 'info');
      });
      
      document.getElementById('sizePicker').addEventListener('input', (e) => {
        size = Math.max(1, Math.min(12, parseInt(e.target.value)));
        showNotification(`Brush size: ${size}px`, 'info');
      });
      
      document.getElementById('undo-btn').addEventListener('click', undoAction);
      document.getElementById('redo-btn').addEventListener('click', redoAction);
      document.getElementById('clear-btn').addEventListener('click', clearCanvas);
      document.getElementById('snapshot-btn').addEventListener('click', saveSnapshot);
      
      // Teacher controls
      document.getElementById('teacher-toggle').addEventListener('click', toggleTeacherMode);
      document.getElementById('user-menu').addEventListener('change', switchUser);
      
      // Chat controls - Fixed implementation
      document.getElementById('chat-toggle').addEventListener('click', toggleChat);
      document.getElementById('chat-expand').addEventListener('click', toggleChat);
      document.getElementById('chat-toggle-mobile').addEventListener('click', toggleChat);
      document.getElementById('chat-send').addEventListener('click', sendChat);
      document.getElementById('chat-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChat();
      });
      
      // LaTeX controls
      document.getElementById('latex-close').addEventListener('click', closeLatexPanel);
      document.getElementById('latex-cancel').addEventListener('click', closeLatexPanel);
      document.getElementById('latex-insert').addEventListener('click', insertLatexEquation);
      document.getElementById('latex-input').addEventListener('input', debounce(updateLatexPreview, 300));
      
      // LaTeX samples
      document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const latex = e.currentTarget.dataset.latex;
          document.getElementById('latex-input').value = latex;
          updateLatexPreview();
        });
      });
      
      // Notes
      document.getElementById('note-form').addEventListener('submit', addNote);
      
      // Notes panel controls
      document.getElementById('notes-close').addEventListener('click', closeNotesPanel);
      document.getElementById('notes-float-btn').addEventListener('click', openNotesPanel);
      
      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboardShortcuts);
    }
    
    // Tool Selection
    function selectTool(toolName) {
      tool = toolName;
      
      if (tool === 'latex') {
        openLatexPanel();
      }
      
      updateToolUI();
      updateCursor();
    }
    
    function updateToolUI() {
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.remove('tool-active');
      });
      
      const activeBtn = document.getElementById(`tool-${tool}`);
      if (activeBtn) {
        activeBtn.classList.add('tool-active');
      }
    }
    
    function updateCursor() {
      canvas.className = canvas.className.replace(/canvas-\w+/g, '');
      canvas.classList.add(isDarkMode ? 'canvas-dark' : 'canvas-light');
      
      switch(tool) {
        case 'eraser': canvas.classList.add('canvas-grab'); break;
        case 'pointer': canvas.classList.add('canvas-pointer'); break;
        default: canvas.classList.add('canvas-crosshair'); break;
      }
    }
    
    // Drawing Logic
    const tools = {
      pen: {
        start(x, y) {
          currentAction = {
            type: "pen",
            user: currentUser,
            color, size,
            points: [{x, y}],
            time: Date.now(),
            id: generateId()
          };
        },
        move(x, y) {
          if (currentAction) {
            currentAction.points.push({x, y});
            renderAll();
          }
        },
        end(x, y) {
          if (currentAction) {
            currentAction.points.push({x, y});
            pushAction(currentAction);
            currentAction = null;
            renderAll();
          }
        }
      },
      line: {
        start(x, y) {
          currentAction = {
            type: "line",
            user: currentUser,
            color, size,
            x1: x, y1: y, x2: x, y2: y,
            time: Date.now(),
            id: generateId()
          };
        },
        move(x, y) {
          if (currentAction) {
            currentAction.x2 = x;
            currentAction.y2 = y;
            renderAll();
          }
        },
        end(x, y) {
          if (currentAction) {
            currentAction.x2 = x;
            currentAction.y2 = y;
            pushAction(currentAction);
            currentAction = null;
            renderAll();
          }
        }
      },
      rect: {
        start(x, y) {
          currentAction = {
            type: "rect",
            user: currentUser,
            color, size,
            x1: x, y1: y, x2: x, y2: y,
            time: Date.now(),
            id: generateId()
          };
        },
        move(x, y) {
          if (currentAction) {
            currentAction.x2 = x;
            currentAction.y2 = y;
            renderAll();
          }
        },
        end(x, y) {
          if (currentAction) {
            currentAction.x2 = x;
            currentAction.y2 = y;
            pushAction(currentAction);
            currentAction = null;
            renderAll();
          }
        }
      },
      circle: {
        start(x, y) {
          currentAction = {
            type: "circle",
            user: currentUser,
            color, size,
            x1: x, y1: y, x2: x, y2: y,
            time: Date.now(),
            id: generateId()
          };
        },
        move(x, y) {
          if (currentAction) {
            currentAction.x2 = x;
            currentAction.y2 = y;
            renderAll();
          }
        },
        end(x, y) {
          if (currentAction) {
            currentAction.x2 = x;
            currentAction.y2 = y;
            pushAction(currentAction);
            currentAction = null;
            renderAll();
          }
        }
      },
      eraser: {
        start(x, y) {
          currentAction = {
            type: "eraser",
            user: currentUser,
            size: size * 2.5,
            points: [{x, y}],
            time: Date.now(),
            id: generateId()
          };
          eraseAt(x, y, size * 2.5);
        },
        move(x, y) {
          if (currentAction) {
            currentAction.points.push({x, y});
            eraseAt(x, y, size * 2.5);
            renderAll();
          }
        },
        end(x, y) {
          if (currentAction) {
            currentAction.points.push({x, y});
            pushAction(currentAction);
            currentAction = null;
            renderAll();
          }
        }
      }
    };
    
    // Canvas Event Handlers
    function handlePointerDown(e) {
      if (!canDraw() || tool === 'latex' || tool === 'pointer') return;
      
      const point = getCanvasCoords(e);
      isDrawing = true;
      canvas.setPointerCapture(e.pointerId);
      tools[tool].start(point.x, point.y);
      e.preventDefault();
    }
    
    function handlePointerMove(e) {
      const point = getCanvasCoords(e);
      updateCursorPosition(point.x, point.y);
      
      if (isDrawing && canDraw() && tools[tool]) {
        tools[tool].move(point.x, point.y);
      }
      e.preventDefault();
    }
    
    function handlePointerUp(e) {
      if (!isDrawing) return;
      
      const point = getCanvasCoords(e);
      if (canDraw() && tools[tool]) {
        tools[tool].end(point.x, point.y);
      }
      
      isDrawing = false;
      canvas.releasePointerCapture(e.pointerId);
      e.preventDefault();
    }
    
    function handlePointerLeave() {
      isDrawing = false;
      hideCursorPosition();
    }
    
    // Rendering
    function renderAll() {
      if (!ctx) return;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw all actions
      for (let action of actionStack) {
        drawAction(action);
      }
      
      // Draw current action
      if (currentAction) {
        drawAction(currentAction);
      }
    }
    
    function drawAction(action) {
      ctx.save();
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      
      switch(action.type) {
        case "pen":
          ctx.strokeStyle = action.color;
          ctx.lineWidth = action.size;
          ctx.beginPath();
          for (let i = 0; i < action.points.length; i++) {
            const p = action.points[i];
            if (i === 0) ctx.moveTo(p.x, p.y);
            else ctx.lineTo(p.x, p.y);
          }
          ctx.stroke();
          break;
          
        case "line":
          ctx.strokeStyle = action.color;
          ctx.lineWidth = action.size;
          ctx.beginPath();
          ctx.moveTo(action.x1, action.y1);
          ctx.lineTo(action.x2, action.y2);
          ctx.stroke();
          break;
          
        case "rect":
          ctx.strokeStyle = action.color;
          ctx.lineWidth = action.size;
          ctx.strokeRect(action.x1, action.y1, action.x2 - action.x1, action.y2 - action.y1);
          break;
          
        case "circle":
          ctx.strokeStyle = action.color;
          ctx.lineWidth = action.size;
          const cx = (action.x1 + action.x2) / 2;
          const cy = (action.y1 + action.y2) / 2;
          const rx = Math.abs(action.x2 - action.x1) / 2;
          const ry = Math.abs(action.y2 - action.y1) / 2;
          ctx.beginPath();
          ctx.ellipse(cx, cy, rx, ry, 0, 0, 2 * Math.PI);
          ctx.stroke();
          break;
          
        case "eraser":
          ctx.globalCompositeOperation = "destination-out";
          ctx.lineWidth = action.size;
          ctx.beginPath();
          for (let i = 0; i < action.points.length; i++) {
            const p = action.points[i];
            if (i === 0) ctx.moveTo(p.x, p.y);
            else ctx.lineTo(p.x, p.y);
          }
          ctx.stroke();
          ctx.globalCompositeOperation = "source-over";
          break;
      }
      ctx.restore();
    }
    
    function eraseAt(x, y, size) {
      ctx.save();
      ctx.globalCompositeOperation = "destination-out";
      ctx.beginPath();
      ctx.arc(x, y, size / 2, 0, 2 * Math.PI);
      ctx.fill();
      ctx.globalCompositeOperation = "source-over";
      ctx.restore();
    }
    
    // Action Management
    function pushAction(action) {
      actionStack.push(JSON.parse(JSON.stringify(action)));
      if (actionStack.length > 1000) actionStack.shift();
      redoStack = [];
    }
    
    function undoAction() {
      if (actionStack.length > 0) {
        const action = actionStack.pop();
        redoStack.push(action);
        if (action.type === 'latex') {
          removeLatexById(action.id);
        }
        renderAll();
        showNotification('Action undone', 'info');
      }
    }
    
    function redoAction() {
      if (redoStack.length > 0) {
        const action = redoStack.pop();
        actionStack.push(action);
        if (action.type === 'latex') {
          restoreLatexAction(action);
        }
        renderAll();
        showNotification('Action restored', 'info');
      }
    }
    
    function clearCanvas() {
      if (!canDraw()) return;
      
      if (confirm("⚠️ This will clear the entire whiteboard. Are you sure?")) {
        actionStack = [];
        redoStack = [];
        removeAllLatex();
        renderAll();
        showNotification('Whiteboard cleared', 'success');
      }
    }
    
    // Teacher Controls
    function toggleTeacherMode() {
      teacherControl = !teacherControl;
      const toggle = document.getElementById('teacher-toggle');
      toggle.classList.toggle('active', teacherControl);
      updateStudentAccess();
      
      showNotification(
        teacherControl ? 'Teacher control enabled' : 'Students can now interact',
        teacherControl ? 'warning' : 'success'
      );
    }
    
    function switchUser(e) {
      const previousUser = currentUser;
      currentUser = e.target.value;
      isTeacher = currentUser === "Teacher";
      updateStudentAccess();
      
      showNotification(`Switched to ${currentUser}`, 'info');
      addSystemMessage(`${previousUser} switched to ${currentUser}`);
    }
    
    function canDraw() {
      return isTeacher || !teacherControl;
    }
    
    function updateStudentAccess() {
      const controls = [
        'colorPicker', 'sizePicker', 'undo-btn', 'redo-btn', 
        'clear-btn', 'snapshot-btn'
      ];
      
      controls.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.disabled = !canDraw();
          element.style.opacity = canDraw() ? '1' : '0.5';
        }
      });
      
      // Tool buttons
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.disabled = !canDraw();
        btn.style.opacity = canDraw() ? '1' : '0.5';
      });
      
      // Notes panel controls
      const notesCloseBtn = document.getElementById('notes-close');
      const notesFloatBtn = document.getElementById('notes-float-btn');
      if (notesCloseBtn) {
        notesCloseBtn.disabled = !canDraw();
        notesCloseBtn.style.opacity = canDraw() ? '1' : '0.5';
      }
      if (notesFloatBtn) {
        notesFloatBtn.disabled = !canDraw();
        notesFloatBtn.style.opacity = canDraw() ? '1' : '0.5';
      }
      
      const noteInput = document.getElementById('note-input');
      if (noteInput) {
        noteInput.disabled = !canDraw();
        noteInput.placeholder = canDraw() 
          ? "Add step-by-step notes, explanations, or observations..." 
          : "Teacher has control - students cannot add notes";
      }
    }
    
    // Chat System - Fixed Implementation
    function toggleChat() {
      const chatPanel = document.getElementById('chat-panel');
      const expandBtn = document.getElementById('chat-expand');
      
      isChatOpen = !isChatOpen;
      
      if (isChatOpen) {
        // Show chat panel
        chatPanel.classList.remove('translate-x-full');
        chatPanel.classList.add('chat-panel-enter');
        expandBtn.classList.add('hidden');
        
        // Remove animation class after animation completes
        setTimeout(() => {
          chatPanel.classList.remove('chat-panel-enter');
        }, 300);
      } else {
        // Hide chat panel
        chatPanel.classList.add('chat-panel-exit');
        expandBtn.classList.remove('hidden');
        
        // Add translate class after animation starts
        setTimeout(() => {
          chatPanel.classList.add('translate-x-full');
          chatPanel.classList.remove('chat-panel-exit');
        }, 300);
      }
    }
    
    function sendChat() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      const chatMessage = {
        user: currentUser,
        message: message,
        time: Date.now(),
        id: generateId()
      };
      
      chat.push(chatMessage);
      input.value = '';
      renderChat();
      scrollChatToBottom();
      
      // Simple auto-responses
      if (message.toLowerCase().includes('help')) {
        setTimeout(() => {
          addSystemMessage("💡 Available tools: Pen, Line, Rectangle, Circle, LaTeX equations, Eraser. Use keyboard shortcuts 1-6!");
        }, 1000);
      }
    }
    
    function addSystemMessage(message) {
      const systemMessage = {
        user: "System",
        message: message,
        time: Date.now(),
        id: generateId(),
        isSystem: true
      };
      
      chat.push(systemMessage);
      renderChat();
      scrollChatToBottom();
    }
    
    function renderChat() {
      const container = document.getElementById('chat-messages');
      container.innerHTML = '';
      
      const recentMessages = chat.slice(-50);
      
      for (let msg of recentMessages) {
        const messageEl = document.createElement('div');
        messageEl.className = `p-3 rounded-lg ${msg.isSystem ? 'bg-blue-50 dark:bg-blue-900/20' : 'bg-white dark:bg-gray-700'} shadow-sm animate-fade-in`;
        
        messageEl.innerHTML = `
          <div class="flex items-center gap-2 mb-1">
            <span class="text-xs font-medium ${msg.isSystem ? 'text-blue-600 dark:text-blue-400' : 'text-gray-600 dark:text-gray-400'}">${msg.user}</span>
            <span class="text-xs text-gray-400">${formatTime(msg.time)}</span>
          </div>
          <div class="text-sm text-gray-900 dark:text-white ${msg.isSystem ? 'italic' : ''}">${escapeHtml(msg.message)}</div>
        `;
        
        container.appendChild(messageEl);
      }
    }
    
    function scrollChatToBottom() {
      const container = document.getElementById('chat-messages');
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    }
    
    // LaTeX System
    function openLatexPanel() {
      document.getElementById('latex-panel').classList.remove('hidden');
      document.getElementById('latex-input').focus();
    }
    
    function closeLatexPanel() {
      document.getElementById('latex-panel').classList.add('hidden');
      document.getElementById('latex-input').value = '';
      document.getElementById('latex-preview').innerHTML = '<span class="text-gray-400">Enter LaTeX equation above...</span>';
      selectTool('pen');
    }
    
    function updateLatexPreview() {
      const input = document.getElementById('latex-input');
      const preview = document.getElementById('latex-preview');
      const value = input.value.trim();
      
      if (!value) {
        preview.innerHTML = '<span class="text-gray-400">Enter LaTeX equation above...</span>';
        return;
      }
      
      let math = value;
      if (!math.startsWith('$') && !math.startsWith('\\(')) {
        math = '$' + math + '$';
      }
      
      preview.innerHTML = math;
      
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([preview]).catch(() => {
          preview.innerHTML = '<span class="text-red-500">⚠️ LaTeX syntax error</span>';
        });
      }
    }
    
    function insertLatexEquation() {
      const input = document.getElementById('latex-input');
      const value = input.value.trim();
      
      if (!value) return;
      
      const centerX = canvas.clientWidth / 2;
      const centerY = 100;
      
      insertLatex(value, centerX, centerY);
      closeLatexPanel();
      showNotification('LaTeX equation inserted', 'success');
    }
    
    function insertLatex(tex, x, y) {
      const latexObj = {
        type: "latex",
        user: currentUser,
        tex: tex,
        x: x,
        y: y,
        color: color,
        time: Date.now(),
        id: generateId()
      };
      
      latexList.push(latexObj);
      pushAction(latexObj);
      addLatexOverlay(latexObj);
    }
    
    function addLatexOverlay(latexObj) {
      const overlay = document.createElement('div');
      overlay.className = `latex-overlay absolute z-20 ${isDarkMode ? 'latex-overlay-dark' : 'latex-overlay-light'}`;
      overlay.dataset.id = latexObj.id;
      overlay.style.left = latexObj.x + 'px';
      overlay.style.top = latexObj.y + 'px';
      overlay.style.cursor = canDraw() ? 'move' : 'default';
      overlay.style.fontSize = '18px';
      overlay.style.userSelect = 'none';
      
      let displayTex = latexObj.tex;
      if (!displayTex.startsWith('$') && !displayTex.startsWith('\\(')) {
        displayTex = '$' + displayTex + '$';
      }
      overlay.innerHTML = displayTex;
      
      document.getElementById('whiteboard').appendChild(overlay);
      
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([overlay]);
      }
      
      // Make draggable
      makeDraggable(overlay, latexObj);
    }
    
    function makeDraggable(element, obj) {
      let isDragging = false;
      let offset = { x: 0, y: 0 };
      
      element.addEventListener('pointerdown', (e) => {
        if (!canDraw()) return;
        isDragging = true;
        offset.x = e.clientX - obj.x;
        offset.y = e.clientY - obj.y;
        element.setPointerCapture(e.pointerId);
        element.style.transform = 'scale(1.05)';
        e.stopPropagation();
      });
      
      element.addEventListener('pointermove', (e) => {
        if (!isDragging) return;
        obj.x = e.clientX - offset.x;
        obj.y = e.clientY - offset.y;
        element.style.left = obj.x + 'px';
        element.style.top = obj.y + 'px';
      });
      
      element.addEventListener('pointerup', () => {
        if (isDragging) {
          isDragging = false;
          element.style.transform = '';
        }
      });
    }
    
    function removeLatexById(id) {
      latexList = latexList.filter(l => l.id !== id);
      const element = document.querySelector(`[data-id="${id}"]`);
      if (element) element.remove();
    }
    
    function restoreLatexAction(action) {
      latexList.push(action);
      addLatexOverlay(action);
    }
    
    function removeAllLatex() {
      latexList = [];
      document.querySelectorAll('.latex-overlay').forEach(el => el.remove());
    }
    
    // Notes System
    function addNote(e) {
      e.preventDefault();
      const input = document.getElementById('note-input');
      const text = input.value.trim();
      
      if (!text) return;
      
      const note = {
        user: currentUser,
        text: text,
        time: Date.now(),
        id: generateId()
      };
      
      notes.push(note);
      input.value = '';
      renderNotes();
      showNotification('Note added', 'success');
    }
    
    function renderNotes() {
      const container = document.getElementById('note-list');
      container.innerHTML = '';
      
      const recentNotes = notes.slice(-10);
      
      for (let note of recentNotes) {
        const noteEl = document.createElement('div');
        noteEl.className = 'bg-white/95 dark:bg-gray-800/95 glass rounded-lg p-3 border border-gray-200 dark:border-gray-700 shadow-sm animate-fade-in';
        
        noteEl.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-medium text-blue-600 dark:text-blue-400">${note.user}</span>
            <span class="text-xs text-gray-400">${formatTime(note.time)}</span>
          </div>
          <div class="text-sm text-gray-900 dark:text-white">${escapeHtml(note.text)}</div>
        `;
        
        container.appendChild(noteEl);
      }
    }
    
    // Notes Panel Controls
    function closeNotesPanel() {
      isNotesOpen = false;
      const notesPanel = document.getElementById('notes-panel');
      const floatingBtn = document.getElementById('notes-float-btn');
      
      notesPanel.classList.add('notes-panel-hide');
      
      setTimeout(() => {
        notesPanel.classList.add('notes-panel-hidden');
        notesPanel.classList.remove('notes-panel-hide');
        
        // Show floating button
        floatingBtn.classList.remove('hidden');
        floatingBtn.classList.add('floating-btn-show');
        
        // Remove animation class after animation completes
        setTimeout(() => {
          floatingBtn.classList.remove('floating-btn-show');
        }, 300);
      }, 300);
      
      showNotification('Notes panel closed', 'info');
    }
    
    function openNotesPanel() {
      isNotesOpen = true;
      const notesPanel = document.getElementById('notes-panel');
      const floatingBtn = document.getElementById('notes-float-btn');
      
      // Hide floating button
      floatingBtn.classList.add('hidden');
      
      // Show notes panel
      notesPanel.classList.remove('notes-panel-hidden');
      notesPanel.classList.add('notes-panel-show');
      
      // Remove animation class after animation completes
      setTimeout(() => {
        notesPanel.classList.remove('notes-panel-show');
      }, 300);
      
      showNotification('Notes panel opened', 'info');
    }
    
    // Snapshot System
    function saveSnapshot() {
      const button = document.getElementById('snapshot-btn');
      const originalText = button.innerHTML;
      
      button.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
      button.disabled = true;
      
      try {
        // Create export canvas
        const exportCanvas = document.createElement('canvas');
        const exportCtx = exportCanvas.getContext('2d');
        
        exportCanvas.width = canvas.width;
        exportCanvas.height = canvas.height;
        
        // Set background color based on theme
        exportCtx.fillStyle = isDarkMode ? '#1f2937' : '#ffffff';
        exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
        exportCtx.drawImage(canvas, 0, 0);
        
        // Export
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        const link = document.createElement('a');
        link.href = exportCanvas.toDataURL('image/png', 1.0);
        link.download = `mathboard-${timestamp}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Whiteboard saved successfully! 📷', 'success');
      } catch (error) {
        console.error('Export error:', error);
        showNotification('Failed to export image', 'error');
      } finally {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }
    
    // Keyboard Shortcuts
    function handleKeyboardShortcuts(e) {
      // Global shortcuts
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'z':
            e.preventDefault();
            if (e.shiftKey) redoAction();
            else undoAction();
            break;
          case 's':
            e.preventDefault();
            saveSnapshot();
            break;
        }
      }
      
      // Tool shortcuts (only when not typing)
      if (!e.ctrlKey && !e.metaKey && !e.altKey && !isTyping()) {
        switch(e.key) {
          case '1': selectTool('pen'); break;
          case '2': selectTool('line'); break;
          case '3': selectTool('rect'); break;
          case '4': selectTool('circle'); break;
          case '5': selectTool('eraser'); break;
          case '6': selectTool('latex'); break;
          case 'n':
          case 'N':
            if (isNotesOpen) closeNotesPanel();
            else openNotesPanel();
            break;
        }
      }
      
      // LaTeX panel shortcuts
      if (document.getElementById('latex-panel').classList.contains('hidden') === false) {
        if (e.key === 'Escape') {
          closeLatexPanel();
        } else if (e.key === 'Enter' && e.target.id === 'latex-input') {
          insertLatexEquation();
        }
      }
    }
    
    function isTyping() {
      const activeElement = document.activeElement;
      return activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA');
    }
    
    // Utility Functions
    function getCanvasCoords(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: (e.clientX - rect.left) * (canvas.width / rect.width) / dpr,
        y: (e.clientY - rect.top) * (canvas.height / rect.height) / dpr
      };
    }
    
    function updateCursorPosition(x, y) {
      const cursorEl = document.getElementById('cursor-pos');
      cursorEl.textContent = `(${Math.round(x)}, ${Math.round(y)})`;
      cursorEl.style.opacity = '1';
    }
    
    function hideCursorPosition() {
      const cursorEl = document.getElementById('cursor-pos');
      cursorEl.style.opacity = '0';
    }
    
    function generateId() {
      return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Notification System
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = 'notification p-4 rounded-lg shadow-lg max-w-sm';
      
      const colors = {
        success: 'bg-green-100 dark:bg-green-900 border border-green-200 dark:border-green-700 text-green-800 dark:text-green-200',
        error: 'bg-red-100 dark:bg-red-900 border border-red-200 dark:border-red-700 text-red-800 dark:text-red-200',
        warning: 'bg-yellow-100 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 text-yellow-800 dark:text-yellow-200',
        info: 'bg-blue-100 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 text-blue-800 dark:text-blue-200'
      };
      
      notification.className += ' ' + colors[type];
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('removing');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
  </script>
</body>
</html>